import React, { useEffect, useState } from "react";
import { useParams, useNavigate } from "react-router-dom";
import { IoCaretBackCircle } from "react-icons/io5";
import Swal from "sweetalert2"; // SweetAlert2ë¥¼ ì‚¬ìš©í•˜ì—¬ ê²½ê³  ì°½ ì²˜ë¦¬
import "../css/ReviewDetail.css";

const ReviewDetail = () => {
    const { id } = useParams();
    const navigate = useNavigate();
    const [reviewData, setReviewData] = useState(null);
    const [loading, setLoading] = useState(true);
    const [currentUser, setCurrentUser] = useState(null); // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥
    const [isUserLoggedIn, setIsUserLoggedIn] = useState(false); // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬

    // ì„¸ì…˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸°
    useEffect(() => {
        const fetchSession = async () => {
            try {
                const response = await fetch("http://localhost:8080/api/session", {
                    method: "GET",
                    credentials: "include",
                });
                const data = await response.json();

                if (data.authenticated) {
                    setCurrentUser(data.user);
                    setIsUserLoggedIn(true);
                    console.log("í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´:", data.user);
                } else {
                    setIsUserLoggedIn(false);
                }
            } catch (error) {
                console.error("ì„¸ì…˜ í™•ì¸ ì˜¤ë¥˜:", error);
                setIsUserLoggedIn(false);
            }
        };

        fetchSession();
    }, []);

    useEffect(() => {
        const fetchReviewData = async () => {
            try {
                const response = await fetch(`http://localhost:8080/api/review/${id}`);
                if (!response.ok) {
                    throw new Error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                const data = await response.json();

                if (data) {
                    setReviewData({
                        id: data.review_id,
                        title: data.title,
                        createdAt: data.createdAt,
                        username: data.username,
                        content: data.content,
                        rating: data.rating,
                    });
                }
            } catch (error) {
                console.error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                setReviewData(null);
                Swal.fire("ì˜¤ë¥˜", "ë¦¬ë·° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
            } finally {
                setLoading(false);
            }
        };

        fetchReviewData();
    }, [id]);

    const handleDelete = async () => {
        Swal.fire({
            title: "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "ì‚­ì œ",
            cancelButtonText: "ì·¨ì†Œ",
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const response = await fetch(`http://localhost:8080/api/review/${id}`, {
                        method: "DELETE",
                    });
                    if (!response.ok) {
                        throw new Error("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                    Swal.fire("ì‚­ì œ ì™„ë£Œ!", "ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "success").then(() => {
                        navigate("/review"); // ë¦¬ë·° ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
                    });
                } catch (error) {
                    console.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    Swal.fire("ì˜¤ë¥˜", "ì‚­ì œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
                }
            }
        });
    };

    const handleEdit = () => {
        navigate(`/review/edit/${reviewData.id}`);
    };

    if (loading) {
        return <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>;
    }

    if (!reviewData) {
        return <p>í•´ë‹¹ ë¦¬ë·° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>;
    }

    // currentUserì™€ reviewDataê°€ ëª¨ë‘ ë¡œë”©ëœ í›„ì— ë¹„êµ
    const isOwner = currentUser && reviewData && currentUser === reviewData.username;

    return (
        <div className="review-detail-container">
            <div className="review-detail-header">
                <div className="review-back-button" onClick={() => navigate(-1)}>
                    <IoCaretBackCircle size={32} />
                </div>
            </div>

            <div className="review-detail-form-container">
                <div className="review-detail-form">
                    <div className="review-detail-form-header">
                        <h2 className="review-detail-title">{reviewData.title}</h2>
                        <p><strong>ì‘ì„±ë‚ ì§œ:</strong> {reviewData.createdAt}</p>
                        <p><strong>ì‘ì„±ì:</strong> {reviewData.username}</p>
                        <div className="review-detail-title-header">
                            <h3>ğŸ“„ ë¦¬ë·° ë‚´ìš©</h3>
                        </div>
                    </div>

                    <div className="review-detail-text">
                        <p><strong>í‰ì :</strong> {reviewData.rating}ì </p>
                        <p><strong>ë‚´ìš©:</strong> {reviewData.content}</p>
                    </div>
                </div>
            </div>
            {isOwner && (
                <div className="review-detail-buttons">
                    <button onClick={handleEdit} className="review-detail-button">ìˆ˜ì •í•˜ê¸°</button>
                    <button onClick={handleDelete} className="review-detail-button">ì‚­ì œí•˜ê¸°</button>
                </div>
            )}
        </div>
    );
};

export default ReviewDetail;
